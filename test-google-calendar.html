<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Test</title>
</head>
<body>
    <h1>Googleカレンダー連携テスト</h1>
    <button onclick="testCalendar()">テスト: Googleカレンダーに追加</button>
    <pre id="result" style="background: #f5f5f5; padding: 10px; margin-top: 20px;"></pre>

    <script>
        function testCalendar() {
            const resultEl = document.getElementById('result');
            resultEl.textContent = 'テスト中...\n\n';

            // テストデータ
            const todo = {
                title: 'テストTODO',
                content: 'これはテストです',
                deadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 明日
            };

            resultEl.textContent += `TODOデータ:\n`;
            resultEl.textContent += `タイトル: ${todo.title}\n`;
            resultEl.textContent += `内容: ${todo.content}\n`;
            resultEl.textContent += `期限: ${todo.deadline}\n\n`;

            const deadlineDate = new Date(todo.deadline);
            resultEl.textContent += `期限日（Dateオブジェクト）: ${deadlineDate}\n`;
            resultEl.textContent += `UTC時刻: ${deadlineDate.toUTCString()}\n\n`;

            // 開始時刻: 期限日の1時間前
            const startDate = new Date(deadlineDate);
            startDate.setHours(startDate.getHours() - 1);
            
            // 終了時刻: 期限日
            const endDate = new Date(deadlineDate);

            // ISO 8601形式に変換（YYYYMMDDTHHmmssZ）
            const formatDate = (date) => {
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
            };

            const startDateStr = formatDate(startDate);
            const endDateStr = formatDate(endDate);

            resultEl.textContent += `開始時刻: ${startDateStr}\n`;
            resultEl.textContent += `終了時刻: ${endDateStr}\n\n`;

            // URLエンコード
            const title = encodeURIComponent(todo.title);
            const details = encodeURIComponent(todo.content || '');
            const location = encodeURIComponent('');

            // Google Calendar URLを作成
            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDateStr}/${endDateStr}&details=${details}&location=${location}`;

            resultEl.textContent += `生成されたURL:\n${googleCalendarUrl}\n\n`;
            resultEl.textContent += `URLをクリックして開く: <a href="${googleCalendarUrl}" target="_blank">${googleCalendarUrl}</a>\n\n`;

            // 新しいウィンドウで開く
            const newWindow = window.open(googleCalendarUrl, '_blank');
            
            if (!newWindow) {
                resultEl.textContent += '⚠️ ポップアップがブロックされました！\n';
                resultEl.textContent += 'ブラウザの設定でポップアップを許可してください。\n';
            } else {
                resultEl.textContent += '✅ Googleカレンダーを新しいウィンドウで開きました。\n';
            }
        }
    </script>
</body>
</html>
